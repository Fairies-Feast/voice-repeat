<h1>Voice Repeat</h1>
<script>
  /*
Copyright, amsilla.com
One has been built by amsilla.com
Copying is allowed, but this stamp certifies that it has been made by amsilla.com
*/
// things: faces, open doors, make food, ChatGPT, ShieldContainers
// done: faces

//var element_start_b = document.getElementById("startb");
var speechRecognition;
var element_start_b = document.body;
var currentPlay = "";
function startPlaying(x) {
  return new Promise((resolve, reject) => {
    if (currentPlay) {
      currentPlay.pause();
    }
    currentPlay = new Audio(x);
    currentPlay.volume = 1;

    currentPlay.oncanplaythrough = () => {
      //Resolve when audio is ready to play
      currentPlay.play();
      resolve(); // Audio played successfully
    };

    currentPlay.onerror = () => {
      reject(new Error("Audio file not found")); // Reject if there's an error
    };
  });
}
async function onerespond(message) {
  var msg = message.toLowerCase().trim();
  return msg;
}

function oneface(face) {
  // Faces: Smiling, Normal, Thinking
  document.getElementById(
    "oneface"
  ).innerHTML = `<img src="${face}.png" height='300px' width='auto'>`;
}
function onespeak(d) {
  // Web speech api Say something
  //alert(v)
  var v = d;
  const synthesis = window.speechSynthesis;
  if (v !== "") {
    const utterance = new SpeechSynthesisUtterance(v);
    // Optionally, you can configure the speech synthesis parameters
    utterance.rate = 1; // Speech rate (default is 1)
    utterance.pitch = 1; // Speech pitch (default is 1)
    // Speak the text
    synthesis.speak(utterance);
  }
}

function on_speak(msg) {
  onerespond(msg)
    .then((response) => {
      // Use .then to handle the promise resolution
      onespeak(response); // Call onespeak with the actual response text
    })
    .catch((error) => {
      console.error("Error in onerespond:", error);
      // Handle potential errors from onerespond
    });
}

function attemptToEnable() {
  if (start_b) {
    speechRecognition.start();
    document.getElementById("startb").classList.add("listen");
    start_b = false;
  } else if (!start_b) {
    speechRecognition.stop();
    document.getElementById("startb").classList.remove("listen");
    start_b = true;
  }
}

if ("webkitSpeechRecognition" in window) {
  // oneface('normal')
  speechRecognition = new webkitSpeechRecognition();
  speechRecognition.continuous = true;
  speechRecognition.interimResults = true;
  speechRecognition.lang = "en-US";

  //speechRecognition.onstart = () => {
  //  console.log("User Started talking")
  //};
  speechRecognition.onend = () => {
    console.log("Microphone restarted or stopped");
    if (!start_b) {
      // !startb means listening
      speechRecognition.start(); // Restart speech recognition
    }
  };
  speechRecognition.onError = () => {
    document.body.innerHTML =
      "<h1>Sorry, something went wrong.</h1><p>If you contact a support person from Amsilla, give them this code: SPEECH-REQUEST-DIED"; // Speech recognition failed; look at the console
  };

  let final_transcript = "";

  speechRecognition.onresult = (event) => {
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        // Process only when the speech recognition is final
        let final_transcript = event.results[i][0].transcript.trim();
        on_speak(final_transcript); // call on_speak function with the final_transcript string
      }
    }
  };

  var start_b = true; // true means not listening
  element_start_b.addEventListener("click", attemptToEnable);
  // Start speech recognition:
  // [sr].start()
  // [sr].stop()
  // [terminal].run("kill 1")
} else {
  document.body.innerHTML =
    "<h1>Webkit Speech Recognition is not enabled in your browser</h1><p>Try:</p><ul><li>Enabling it</li><li>Using another browser</li></ul>";
}

setTimeout(() => {
  attemptToEnable();
}, 500);
</script>
